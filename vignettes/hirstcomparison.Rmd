---
title: "test"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warnings = FALSE, 
                      message = FALSE)

# This project is using renv dependency management, for more info: https://cran.r-project.org/web/packages/renv/vignettes/renv.html

library(tidyverse)
library(lubridate)
library(ggpubr)
library(here)
# library(Amelia) # only used for one fct call to missmap()

devtools::load_all()

# I like the look of these plots
# devtools::install_github('cttobin/ggthemr')
ggthemr::ggthemr("fresh")

# caTools and bitops are required to knit this vignette, those are not tracked by renv and must be installed by the user
# Due to old R-Version caTools must be installed from CRAN Archive, in order to knit markdown documents.
# packageurl <- "http://cran.r-project.org/src/contrib/Archive/caTools/caTools_1.17.1.1.tar.gz"
# install.packages(packageurl, repos=NULL, type="source")

```

# Data

## Import

```{r}

# The data was provided by Fiona Tummon, in form of 10-minute pollen counts.
# The data prep until that point was not re-evaluated.
# The datetimes were provided in a seperate file (in local time)
# PAY2, PAY4 and PAY8 are three different pollen traps
# lines 2,4,6,7 are four different lines, along which the pollen were manually counted under the microsope.
# Lines 2 and 6 were counted in 2013, whereas lines 4 and 7 were counted in 2019

path_data <- paste0(here::here(), "/ext-data/")
files_data <- list.files(path_data, pattern = "2013_10min.csv")
files_datetimes <- list.files(path_data, pattern = "dates_10min.csv")

data_raw <-
  map(files_data, ~ read_delim(
    paste0(path_data, .x),
    delim = ";",
    col_names = TRUE,
    col_types = cols(.default = "n"),
    na = "nan"
    )
  ) %>% 
  setNames(files_data)

dates_raw <-
  map(files_datetimes,~ read_delim(
    paste0(path_data, .x),
    delim = ";",
    col_names = FALSE,
    col_types = cols(.default = "n") # dates and times are in a weird format, have to import as numeric as a consequence
    )
  ) %>% 
  setNames(files_datetimes)

dates <- map(dates_raw, ~mutate(
  .x,
  time = sprintf("%04d", as.integer(X2)), # otherwise we lose leading zeros
  datetime = ymd_hm(paste0(X1, time)),
  datetime_adj = datetime - minutes(10), # This is necessary to cope with the guidelines mentioned below
  hour = hour(datetime_adj) + 1,
  date = date(datetime_adj)) %>% 
  select(datetime, date, hour)
  )

# Combining the measurements with the datetimes for the three traps
# It appears that the traps have slightly different observations (e.g. 9 minutes past the full hour instead of 10). This will have no impact, once the concentrations are averaged per hour
data <- map2(data_raw, rep(1:3, each = 4), ~bind_cols(.x, dates[[.y]]) %>% mutate(trap = as.factor(2^(.y))))

# Create a new variable to differentiate between counted lines; note that traps were already defined in the previous map-call above
data <- map2(data, rep(c(2, 4, 6, 7), 3), ~mutate(.x, line = as.factor(.y)))

# We are only interested on a subset of the data
# The order of variables is different in the PAY2 and PAY6 data, hence we quicly sort them here:
species_selection <- c("Castanea", "Alnus", "Ulmus", "Cupress", "Fraxinus", "Fagus", "Juglans", "Plantago", "Corylus", 
    "Pinus", "Quercus", "Rumex", "Platanus", "Populus", "Poaceae", "Salix", "Betula", "Carpinus", 
    "Urticacées", "Taxus", "Picea")

data = map(data, ~select(.x, 
    kacastz0, kaalnuz0, kaulmuz0, kacuprz0, kafraxz0, kafaguz0, kajuglz0, khplanz0, kacoryz0, 
    kapinuz0, kaquerz0, khrumez0, kaplatz0, kapopuz0, khpoacz0, kasaliz0, kabetuz0, kacarpz0, 
    khurtiz0, kataxuz0, kapicez0, datetime, date, hour, trap, line) %>% 
  setNames(c(species_selection, "datetime", "date", "hour", "trap", "line")))

```

## Data Bias Correction

The team in Payerne found that the air sucking rates of the Hirst traps are actually higher in reality than reported by the manufacturer.
The traps suck in 13.5 l per minute instead of 10 l per minute. Hence our Pollen counts per 10 minutes are too high and should be reduced by a factor of 1.35.

```{r}
data <- map(data, ~mutate_at(.x, vars(species_selection), ~./1.35))
```

There are a few missing measurements, we will impute/exclude those in the next step.
Generally, if one species is NA in one specific trap/line at a certain time, then all species are NA.
Hence we could assume that the traps had a malfunction during that time.
What is surprising though is the fact that not all lines have the same amount of NAs.
This might suggest that some entries were omitted during the manual pollen counting exercise.
If these values are outside of the blooming season then we don't have an issue. This should be further evaluated.

## Imputation and Timeframe Selection

```{r}
# Later measurements are NA for all traps and hence can be removed, to make sure that all traps and lines have the same amount of rows.
map(data, ~Amelia::missmap(.x, y.labels = "", y.at = 1, col = ggthemr::swatch()[c(4,2)]))

# Make sure that all dataframes have the same amount of rows, working with max amount of data available
data <- map(data, ~.x %>% filter(datetime <= as_datetime("2013-07-01 10:00:00"),
                                 datetime >= as_datetime("2013-04-01 11:30:00"))) 

# data <- map(data, ~.x %>% replace(is.na(.), 0)) # NAs are currently not imputed, there are some missing values though. In the functions below we remove NA whily executing summarising functions (e.g. sum(x, na.rm = TRUE))

# We will exclude all observations where the measurement of all lines and traps is lower than 10 Pollen/m^3, as discussed with Regula Gehrig
# We are mostly interested in observations where Pollen are actually being measured and not the ones where no trap detected anything (which is usually true for many days outside the blooming season).
data <- data %>% 
  bind_rows %>%   
  group_by(datetime) %>% 
  mutate_at(vars(species_selection), function(x){
      if(sum(x, na.rm = TRUE) > 0) 
        return(x)
      else 
        return(NA_real_)
  }) %>% 
  ungroup %>% 
  group_split(trap,line)



```

## Aggregation

One of the questions is, how long the observation period should be for the Pollen traps to produce robust results on any specific day.
The original time span is 10minutes, we want to look at various average concentration (e.g. hourly, 3 hours, 6 hours, daily).

There are some general guidelines from Regula Gehrig on how to average concentration that should be followed here.

Die Stundenwerte werden wie folgt aus den 10-Minutenwerten berechnet:
z.B. Wert für 6:00 Uhr UTC wird berechnet aus 05:10 – 6:00 UTC

Die 3-h-Werte, die du auch im DWH findest, werden so berechnet:
z.B. Wert um 09:00 UTC: 06:10-09:00

Die Tageswerte werden bei den Pollen glaub ich aus den Stundenwerten berechnet aus:
01:00 – 24:00 (d.h. 00:00 – im DWH gibt es keinen Wert 24:00) UTC 

```{r}

# Hour 1 represents the duration 00:10 - 01:00, and same for all hours up to 24
data_hourly <- map(data, ~.x %>% 
  group_by(date, hour, trap, line) %>% 
  summarise_at(vars(species_selection), ~mean(., na.rm = TRUE)) %>% 
  ungroup())

# # The data comes in a sorted format by date and time, below I check that the start and endpoint is the same when averaged hourly
# # This is actually the case with the first measurement on 2013-04-01 11 o'clock and the last on 2013-07-01 - 10 o'clock (as trimmed above).
# # All lines and traps show the same observations.
# map(data_hourly, ~.x %>%
#   slice(c(1, nrow(.x))) %>%
#   rowid_to_column) %>%
#   bind_rows() %>%
#   arrange(rowid)
# # All the traps have the same amount of unique observations
# map(data_hourly, ~.x %>% select(date, hour) %>% unique %>% nrow)
# map(data_hourly, ~.x %>% slice(tail(row_number(), 10)))

data_hours3 <- map(data, ~.x %>% 
  mutate(hours3 = case_when(
    hour >= 0 & hour < 3 ~ "06:00",
    hour >= 3 & hour < 6 ~ "12:00",
    hour >= 6 & hour < 9 ~ "18:00",
    hour >= 9 & hour < 12 ~ "24:00",
    hour >= 12 & hour < 15 ~ "06:00",
    hour >= 15 & hour < 18 ~ "12:00",
    hour >= 18 & hour < 21 ~ "18:00",
    hour >= 21 & hour < 24 ~ "24:00"
    )
  ) %>% 
  group_by(date, hours3, trap, line) %>% 
  summarise_at(vars(species_selection), ~mean(., na.rm = TRUE)) %>% 
  ungroup())

data_hours6 <- map(data, ~.x %>% 
  mutate(hours6 = case_when(
    hour >= 1 & hour <= 6 ~ "06:00",
    hour > 6 & hour <= 12 ~ "12:00",
    hour > 12 & hour <= 18 ~ "18:00",
    hour > 18 & hour <= 24 ~ "24:00"
    )
  ) %>% 
  group_by(date, hours6, trap, line) %>% 
  summarise_at(vars(species_selection), ~mean(., na.rm = TRUE)) %>% 
  ungroup())

data_hours12 <- map(data, ~.x %>% 
  mutate(hours12 = case_when(
    hour >= 1 & hour <= 12 ~ "12:00",
    hour > 12 & hour <= 24 ~ "24:00"
    )
  ) %>% 
  group_by(date, hours12, trap, line) %>% 
  summarise_at(vars(species_selection), ~mean(., na.rm = TRUE)) %>% 
  ungroup())

data_daily <- map(data_hourly, ~.x %>% 
                    group_by(date, trap, line) %>% 
                    summarise_at(vars(species_selection), ~mean(., na.rm = TRUE)) %>% 
                    ungroup())

```

# Visualization

Now let's plot some time series to get a better overview of the data. In the plot below the user can select any species and temporal resolution to compare the measurements from different lines and traps.

```{r}

plot <- plot_pollen(species = "Poaceae", resolution = "daily", group = "trap", traps = c(2, 4, 8), rm_zeros = TRUE)
plot
# ggsave(filename = "plot.png", plot = plot, width = 8, height = 4.5)

```


# Statistical Comparison

## Parametric / ANOVA

### F-Test

### Contrasts / Tukey HSD

## Non-Parametric / Rank-Based Symmetrical

### Kruskal-Vallis Test

### Dunn??








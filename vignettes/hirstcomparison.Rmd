---
title: "test"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
# library(Amelia) # only used for one fct call to missmap()

```

# Load Data

```{r}

# The data was provided by Fiona Tummon, in form of 10-minute pollen counts.
# The data prep until that point was not re-evaluated.
# The datetimes were provided in a seperate file (tbd whether those are UTC or not)
# PAY2, PAY4 and PAY8 are three different pollen traps
# lines 2,4,6,7 are four different lines, along which the pollen were manually counted under the microsope.
# Lines 2 and 6 were counted in 2013, whereas lines 4 and 7 were counted in 2019

path_data <- paste0(here::here(), "/ext-data/")
files_data <- list.files(path_data, pattern = "2013_10min.csv")
files_datetimes <- list.files(path_data, pattern = "dates_10min.csv")

data_raw <-
  map(files_data, ~ read_delim(
    paste0(path_data, .x),
    delim = ";",
    col_names = TRUE,
    col_types = cols(.default = "n"),
    na = "nan"
    )
  ) %>% 
  setNames(files_data)

dates_raw <-
  map(files_datetimes,~ read_delim(
    paste0(path_data, .x),
    delim = ";",
    col_names = FALSE,
    col_types = cols(.default = "n") # dates and times are in a weird format, have to import as numeric as a consequence
    )
  ) %>% 
  setNames(files_datetimes)

dates <- map(dates_raw, ~mutate(
  .x,
  time = sprintf("%04d", as.integer(X2)), # otherwise we lose leading zeros
  datetime = ymd_hm(paste0(X1, time)),
  datetime_adj = datetime - minutes(10), # This is necessary to cope with the guidelines mentioned below
  hour = hour(datetime_adj) + 1,
  date = date(datetime_adj)) %>% 
  select(datetime, date, hour)
  )

# Combining the measurements with the datetimes for the three traps
# It appears that the traps have slightly different timestamps
data <- map2(data_raw, rep(1:3, each = 4), ~bind_cols(.x, dates[[.y]]) %>% mutate(trap = as.factor(2^(.y))))

# Create a new variable to differentiate between counted lines; note that traps were already defined in the previous map-call above
data <- map2(data, rep(c(2, 4, 6, 7), 3), ~mutate(.x, line = as.factor(.y)))

# We are only interested on a subset of the data
# The rder of variables is different in the PAY2 and PAY6 data, those are the old counts from 2013
species_selection <- c("Castanea", "Alnus", "Ulmus", "Cupress", "Fraxinus", "Fagus", "Juglans", "Plantago", "Corylus", 
    "Pinus", "Quercus", "Rumex", "Platanus", "Populus", "Poaceae", "Salix", "Betula", "Carpinus", 
    "Urticacées", "Taxus", "Picea")

data = map(data, ~select(.x, 
    kacastz0, kaalnuz0, kaulmuz0, kacuprz0, kafraxz0, kafaguz0, kajuglz0, khplanz0, kacoryz0, 
    kapinuz0, kaquerz0, khrumez0, kaplatz0, kapopuz0, khpoacz0, kasaliz0, kabetuz0, kacarpz0, 
    khurtiz0, kataxuz0, kapicez0, datetime, date, hour, trap, line) %>% 
  setNames(c(species_selection, "datetime", "date", "hour", "trap", "line")))

# map(dates, ~summary(.x))
# map(data_raw, ~summary(.x))


```

There are a few missing measurements, we will impute/exclude those in the next step.
Generally, there if one species is NA at a certain time, then all species are NA.
Hence we could assume that the traps had a malfunction during that time.
What is surprising though is the fact that not all lines have the same amount of NAs.
This might suggest that some entries were omitted during the manual pollen counting exercise.
If these values are outside of the blooming season then we don't have an issue, I will check this below.

```{r}
# Later measurements are NA for all traps and hence can be removed, to make sure that all traps and lines have the same amount of rows.
data <- map(data, ~.x %>% filter(datetime <= as_datetime("2013-07-01 10:00:00"))) 
data <- map(data, ~.x %>% drop_na()) # Current solution to remove all NAs from dataset

map(data, ~Amelia::missmap(.x))

```

The team in Payerne fuond that the air sucking rates of the Hirst traps are actually higher in reality than reported by the manufacturer.
The traps suck in 13.5 l per minute instead of 10 l per minute. Hence our Pollencounts per 10minutes are too high and should be reduced by a factor of 1.35.

```{r}
data <- map(data, ~mutate_at(.x, vars(species_selection), ~./1.35))
```

One of the questions is, how long the observation period should be for the Pollen traps to produce robust results on any specific day.
The original timespan is 10minutes, we want to look at various average concentration (e.g. hourly, 3 hours, 6 hours, daily).

There are some general guidelines from Reguöa Gehrig on how to average concentration that should be followed here.

Die Stundenwerte werden wie folgt aus den 10-Minutenwerten berechnet:
z.B. Wert für 6:00 Uhr UTC wird berechnet aus 05:10 – 6:00 UTC

Die 3-h-Werte, die du auch im DWH findest, werden so berechnet:
z.B. Wert um 09:00 UTC: 06:10-09:00

Die Tageswerte werden bei den Pollen glaub ich aus den Stundenwerten berechnet aus:
01:00 – 24:00 (d.h. 00:00 – im DWH gibt es keinen Wert 24:00) UTC 

```{r}

# Hour 1 represents the duration 00:10 - 01:00, and same for all hours up to 24
data_hourly <- map(data, ~.x %>% 
  group_by(date, hour, trap, line) %>% 
  summarise_at(vars(species_selection), ~mean(.)) %>% 
  ungroup())

# # The data comes in a sorted format by date and time, below I check that the start and endpoint is the same when averaged hourly
# # This is actually the case with the first measurement on 2013-04-01 11 o'clock and the last on 2013-07-01 - 10 o'clock (as trimmed above).
# # All lines and traps show the same timestamps.
# map(data_hourly, ~.x %>%
#   slice(c(1, nrow(.x))) %>%
#   rowid_to_column) %>%
#   bind_rows() %>%
#   arrange(rowid)
# # All the traps have the same amount of unique timestamps
# map(data_hourly, ~.x %>% select(date, hour) %>% unique %>% nrow)
# map(data_hourly, ~.x %>% slice(tail(row_number(), 10)))

data_hours3 <- map(data_hourly, ~.x %>% 
  mutate(hours3 = case_when(
    hour >= 0 & hour < 3 ~ "00:10 - 06:00",
    hour >= 3 & hour < 6 ~ "06:10 - 12:00",
    hour >= 6 & hour < 9 ~ "12:10 - 18:00",
    hour >= 9 & hour < 12 ~ "18:10 - 24:00",
    hour >= 12 & hour < 15 ~ "00:10 - 06:00",
    hour >= 15 & hour < 18 ~ "06:10 - 12:00",
    hour >= 18 & hour < 21 ~ "12:10 - 18:00",
    hour >= 21 & hour < 24 ~ "18:10 - 24:00"
    )
  ) %>% 
  group_by(date, hours3, trap, line) %>% 
  summarise_at(vars(species_selection), ~mean(.)) %>% 
  ungroup())

data_hours6 <- map(data_hourly, ~.x %>% 
  mutate(hours6 = case_when(
    hour >= 0 & hour < 6 ~ "00:10 - 06:00",
    hour >= 6 & hour < 12 ~ "06:10 - 12:00",
    hour >= 12 & hour < 18 ~ "12:10 - 18:00",
    hour >= 18 & hour < 24 ~ "18:10 - 24:00"
    )
  ) %>% 
  group_by(date, hours6, trap, line) %>% 
  summarise_at(vars(species_selection), ~mean(.)) %>% 
  ungroup())

data_hours12 <- map(data_hourly, ~.x %>% 
  mutate(hours12 = case_when(
    hour >= 0 & hour < 12 ~ "00:10 - 12:00",
    hour >= 12 & hour < 24 ~ "12:10 - 24:00"
    )
  ) %>% 
  group_by(date, hours12, trap, line) %>% 
  summarise_at(vars(species_selection), ~mean(.)) %>% 
  ungroup())

data_daily <- map(data_hourly, ~.x %>% 
                    group_by(date, trap, line) %>% 
                    summarise_at(vars(species_selection), ~mean(.)) %>% 
                    ungroup())

```


Now let's plot some time series to get a better overview of the data.
For better visibility I am displaying hourly sums as a minimum timespan.

```{r}

species <- "Poaceae"
data_plot <- data_daily %>% bind_rows

data_plot %>% 
  # filter(!!sym(species) != 0) %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = !!sym(species), col = trap)) +
  theme_minimal()

bins <- data[[1]] %>% select(Poaceae) %>%  filter(!is.na(Poaceae), Poaceae != 0)%>% unique %>% pull %>% length

data_daily[[1]] %>% 
  # filter(!!sym(species) != 0) %>%
  ggplot() +
  geom_histogram(aes(y = !!sym(species)), bins = bins) +
  coord_flip() +
  theme_minimal()

data_daily[[1]] %>% 
  # filter(!!sym(species) != 0) %>%
  ggplot() +
  geom_boxplot(aes(y = !!sym(species))) +
  theme_minimal()

```












